name: CI

on:
  push:
    branches: [main, master]
  pull_request:

env:
  PYTHON_VERSION: "3.10"
  TOKEN: "dummy-token"
  ADMIN_ID: "0"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install root requirements (site)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi

      - name: Install bot requirements
        run: |
          if [ -f mybot/requirements.txt ]; then
            python -m pip install -r mybot/requirements.txt
          fi

      - name: Smoke imports
        env:
          TOKEN: ${{ secrets.TOKEN || env.TOKEN }}
          ADMIN_ID: ${{ secrets.ADMIN_ID || env.ADMIN_ID }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import importlib.util
          import sys

          root = Path.cwd()
          sys.path.insert(0, str(root))

          if (root / "app.py").exists():
              import app
              print("app import OK")
          else:
              print("app.py not present, skip import")

          cfg_path = root / "mybot" / "config.py"
          if cfg_path.exists():
              spec = importlib.util.spec_from_file_location("mybot_config", cfg_path)
              mod = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(mod)
              print("mybot/config.py import OK")
          else:
              print("mybot/config.py not found, skip")
          PY

